/*
## Summary
Compiles CPP benchmarks for calculating the RCI (relative citation impact) indicator.

## Description
Method: https://github.com/Curtin-Open-Knowledge-Initiative/coki-ries/blob/main/docs/era_2018.md#indicator-relative-citation-impact-rci

## Contacts
julian.tonti-filippini@curtin.edu.au

## License
Apache 2.0

## Requires
table core_papers

## Creates
table benchmarks_cpp_*

*/
const compile = ({
  ns_core = 'project.dataset',
  scope   = 'world',
  digits  = 4,
  replace = false,
}) => `
-- generated by: ${require('path').basename(__filename)}
BEGIN
  -- compute CPP (citation per paper) benchmarks [${scope},${digits}]
  ${replace ? 'CREATE OR REPLACE TABLE' : 'CREATE TABLE IF NOT EXISTS'} \`${ns_core}.benchmarks_cpp_${scope}_${digits}\` AS (
    SELECT 
      SUBSTRING(B.code,0,${digits})  AS code,
      year_published                 AS year,
      COUNT(1)                       AS num_papers,
      COUNTIF(num_citations > 0)     AS num_cited,
      COUNTIF(num_citations = 0)     AS num_uncited,
      SUM(num_citations)             AS sum_citations,
      MAX(num_citations)             AS max_citations,
      AVG(num_citations)             AS avg_citations,
      STDDEV(num_citations)          AS sdev_citations,
      0.0                            AS benchmark
    FROM \`${ns_core}.core_papers\` AS A
    INNER JOIN UNNEST(fors) AS B 
    WHERE LENGTH(B.code) >= ${digits} ${scope == 'local' ? 'AND ARRAY_LENGTH(heps) > 0' : ''}
    GROUP BY code,year 
    ORDER BY code,year
  );
  UPDATE \`${ns_core}.benchmarks_cpp_${scope}_${digits}\` SET benchmark = sum_citations / num_papers WHERE num_papers > 0;
END;`;
function compile_all(args={}) {
  return [
    compile({ ...args, scope:'world', digits:4 }),
    compile({ ...args, scope:'world', digits:2 }),
    compile({ ...args, scope:'local', digits:4 }),
    compile({ ...args, scope:'local', digits:2 }),
  ];
}
module.exports = { compile, compile_all };
if (require.main === module) require('app').cli_compile(compile_all);
